name: Spec Validation

on:
  pull_request:
    paths:
      - 'specs/**'
  push:
    paths:
      - 'specs/**'

jobs:
  validate-specs:
    runs-on: ubuntu-latest
    name: Validate Spec Files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate spec files
        run: |
          # Set exit on error
          set -e

          # Color codes
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          NC='\033[0m'

          echo "Validating spec files..."

          # Find all spec files (not implementation logs)
          SPEC_FILES=$(find specs -name 'spec_*.md' ! -name '*.implementation.md' || true)

          if [ -z "$SPEC_FILES" ]; then
            echo "No spec files found to validate"
            exit 0
          fi

          VALIDATION_FAILED=0

          # Validate each spec file
          while IFS= read -r spec_file; do
            echo ""
            echo "Validating: $spec_file"

            # Check 1: Validate filename pattern
            if ! echo "$spec_file" | grep -qE 'specs/spec_[0-9]{8}_[0-9]{6}_(feature|bug)_--.+\.md$'; then
              echo -e "${RED}✗ Filename doesn't match required pattern${NC}"
              echo "  Expected: specs/spec_YYYYMMDD_NNNNNN_<type>_--<description>.md"
              echo "  Got:      $spec_file"
              VALIDATION_FAILED=1
              continue
            fi
            echo -e "${GREEN}✓ Filename pattern valid${NC}"

            # Check 2: Verify implementation log file exists
            impl_file="${spec_file%.md}.implementation.md"
            if [ ! -f "$impl_file" ]; then
              echo -e "${RED}✗ Implementation log file missing${NC}"
              echo "  Expected: $impl_file"
              VALIDATION_FAILED=1
              continue
            fi
            echo -e "${GREEN}✓ Implementation log exists${NC}"

            # Check 3: Validate required sections exist in spec file
            missing_sections=()

            for section in "Critical Questions" "## What" "## Why" "## How" "## Verification"; do
              if ! grep -q "^#* $section" "$spec_file"; then
                missing_sections+=("$section")
              fi
            done

            if [ ${#missing_sections[@]} -gt 0 ]; then
              echo -e "${RED}✗ Missing required sections${NC}"
              for section in "${missing_sections[@]}"; do
                echo "    - $section"
              done
              VALIDATION_FAILED=1
              continue
            fi
            echo -e "${GREEN}✓ All required sections present${NC}"

            # Check 4: Validate Verification section has subsections
            if ! grep -q "### Unit Tests" "$spec_file" || \
               ! grep -q "### Integration Tests" "$spec_file" || \
               ! grep -q "### Acceptance Criteria" "$spec_file"; then
              echo -e "${RED}✗ Verification section missing required subsections${NC}"
              echo "  Required: ### Unit Tests, ### Integration Tests, ### Acceptance Criteria"
              VALIDATION_FAILED=1
              continue
            fi
            echo -e "${GREEN}✓ Verification section complete${NC}"

            echo -e "${GREEN}✓ All validation checks passed${NC}"

          done <<< "$SPEC_FILES"

          echo ""

          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo -e "${RED}✗ Spec validation failed${NC}"
            echo ""
            echo "Please fix the issues above."
            echo "Refer to .agent/spec-rules.md for spec file requirements."
            exit 1
          fi

          echo -e "${GREEN}✓ All spec files validated successfully${NC}"
