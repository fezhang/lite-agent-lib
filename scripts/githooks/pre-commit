#!/usr/bin/env bash
# pre-commit hook - Validate spec files comply with .agent/spec-rules.md
#
# This hook validates:
# 1. Spec file naming convention
# 2. Required sections in spec files
# 3. Existence of implementation log files
#
# Installation:
#   cp scripts/githooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged spec files
SPEC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^specs/spec_.*\.md$' || true)

# Filter out implementation log files
SPEC_FILES=$(echo "$SPEC_FILES" | grep -v '\.implementation\.md$' || true)

if [ -z "$SPEC_FILES" ]; then
    # No spec files changed, exit successfully
    exit 0
fi

VALIDATION_FAILED=0

echo -e "${YELLOW}Validating spec files...${NC}"

# Validate each spec file
while IFS= read -r spec_file; do
    echo ""
    echo "Validating: $spec_file"

    # Check 1: Validate filename pattern
    if ! echo "$spec_file" | grep -qE 'specs/spec_[0-9]{8}_[0-9]{6}_(feature|bug)_--.+\.md$'; then
        echo -e "  ${RED}✗ Filename doesn't match required pattern${NC}"
        echo -e "    Expected: specs/spec_YYYYMMDD_NNNNNN_<type>_--<description>.md"
        echo -e "    Got:      $spec_file"
        VALIDATION_FAILED=1
        continue
    fi
    echo -e "  ${GREEN}✓ Filename pattern valid${NC}"

    # Check 2: Verify implementation log file exists
    impl_file="${spec_file%.md}.implementation.md"
    if [ ! -f "$impl_file" ]; then
        echo -e "  ${RED}✗ Implementation log file missing${NC}"
        echo -e "    Expected: $impl_file"
        VALIDATION_FAILED=1
        continue
    fi
    echo -e "  ${GREEN}✓ Implementation log exists${NC}"

    # Check 3: Validate required sections exist in spec file
    missing_sections=()

    for section in "Critical Questions" "## What" "## Why" "## How" "## Verification"; do
        if ! grep -q "^#* $section" "$spec_file"; then
            missing_sections+=("$section")
        fi
    done

    if [ ${#missing_sections[@]} -gt 0 ]; then
        echo -e "  ${RED}✗ Missing required sections${NC}"
        for section in "${missing_sections[@]}"; do
            echo -e "    - $section"
        done
        VALIDATION_FAILED=1
        continue
    fi
    echo -e "  ${GREEN}✓ All required sections present${NC}"

    # Check 4: Validate Verification section has subsections
    if ! grep -q "### Unit Tests" "$spec_file" || \
       ! grep -q "### Integration Tests" "$spec_file" || \
       ! grep -q "### Acceptance Criteria" "$spec_file"; then
        echo -e "  ${RED}✗ Verification section missing required subsections${NC}"
        echo -e "    Required: ### Unit Tests, ### Integration Tests, ### Acceptance Criteria"
        VALIDATION_FAILED=1
        continue
    fi
    echo -e "  ${GREEN}✓ Verification section complete${NC}"

    echo -e "  ${GREEN}✓ All validation checks passed${NC}"

done <<< "$SPEC_FILES"

echo ""

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "${RED}✗ Spec validation failed${NC}"
    echo ""
    echo "Please fix the issues above before committing."
    echo "Refer to .agent/spec-rules.md for spec file requirements."
    echo ""
    echo "To bypass this hook (not recommended): git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}✓ All spec files validated successfully${NC}"
exit 0
